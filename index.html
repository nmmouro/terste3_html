<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta http-equiv="refresh" content="60"> <!-- Atualiza a página a cada 60s -->
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel Integrado</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    margin: 0;
    padding: 0;
  }

  h1 {
    text-align: center;
    margin-top: 20px;
    color: #00eaff;
  }

  .logo {
    width: 180px;
    display: block;
    margin: 20px auto;
  }

  table {
    width: 95%;
    margin: 20px auto;
    border-collapse: collapse;
    font-size: 20px;
  }

  th {
    background: #004d73;
    padding: 10px;
  }

  td {
    padding: 8px;
    border-bottom: 1px solid #333;
  }

  tr.cancelado {
    background: #7a0000 !important;
    color: #fff;
    animation: blink 1.2s infinite;
  }

  @keyframes blink {
    0% { opacity: 1; }
    40% { opacity: .2; }
    100% { opacity: 1; }
  }
</style>
</head>

<body>

<img src="logo.png" class="logo">

<h1>PAINEL</h1>
<table id="PAINEL"></table>

<h1>AGENDA DO DIA</h1>
<table id="AGENDA_DO_DIA"></table>

<h1>AGENDA SERVIÇO SOCIAL</h1>
<table id="AGENDA_SERVICO_SOCIAL"></table>

<script>
// ----------------------------
// Função para converter Date()
// ----------------------------
function parseGoogleDate(value) {
  if (typeof value !== "string") return value;

  const d = value.match(/Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)/);
  if (!d) return value;

  const ano = Number(d[1]);
  const mes = Number(d[2]);
  const dia = Number(d[3]);
  const hora = Number(d[4] ?? 0);
  const min = Number(d[5] ?? 0);

  // CORRIGE:
  // Se for Date(1899...), então é só hora
  if (ano === 1899) {
    return `${String(hora).padStart(2, "0")}:${String(min).padStart(2, "0")}`;
  }

  // Se for data real
  return `${String(dia).padStart(2, "0")}/${String(mes + 1).padStart(2, "0")}/${ano}`;
}

// ----------------------------
// Funciona também para hora isolada
// ----------------------------
function formatHoraSeNecessario(value) {
  if (typeof value !== "string") return value;

  const d = value.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
  if (!d) return value;

  const h = String(Number(d[4])).padStart(2, "0");
  const m = String(Number(d[5])).padStart(2, "0");

  return `${h}:${m}`;
}

// ----------------------------
// Escape HTML contra quebras de layout
// ----------------------------
function escapeHtml(text) {
  if (!text) return text;
  return text
    .toString()
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// ----------------------------
// Carregar dados JSON
// ----------------------------
async function loadData() {
  try {
    const resp = await fetch("./dados.json?nocache=" + Date.now());
    const data = await resp.json();

    renderTable("PAINEL", data["PAINEL"]);
    renderTable("AGENDA_DO_DIA", data["AGENDA DO DIA"]);
    renderTable("AGENDA_SERVICO_SOCIAL", data["AGENDA SERVIÇO SOCIAL"]);

  } catch (e) {
    console.error("Erro ao carregar dados.json:", e);
  }
}

// ----------------------------
// Renderizar em tabela HTML
// ----------------------------
function renderTable(id, dataset) {
  const table = document.getElementById(id);
  if (!dataset) {
    table.innerHTML = "<tr><td>Sem dados</td></tr>";
    return;
  }

  let html = "<tr>";
  dataset.cols.forEach(c => {
    html += `<th>${escapeHtml(c)}</th>`;
  });
  html += "</tr>";

  dataset.rows.forEach(row => {
    const textoLinha = row.map(v => ("" + v).toLowerCase()).join(" ");
    const isCancelado = textoLinha.includes("cancelado");

    html += `<tr class="${isCancelado ? "cancelado" : ""}">`;

    row.forEach((cell, index) => {
      const colName = dataset.cols[index].toLowerCase();
      let val = cell;

      // Detecta CAMPOS DE HORA
      const somenteHora =
        colName.includes("hora") &&
        (id === "PAINEL" || id === "AGENDA_DO_DIA" || id === "AGENDA_SERVICO_SOCIAL");

      if (somenteHora) {
        val = formatHoraSeNecessario(cell);
      } else {
        val = parseGoogleDate(cell);
      }

      html += `<td>${escapeHtml(val)}</td>`;
    });

    html += "</tr>";
  });

  table.innerHTML = html;
}

// ----------------------------
loadData();
// ----------------------------
</script>
</body>
</html>
